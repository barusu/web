<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <title>harvest</title>
    <style>
      body {
        font-size: 16px;
      }
      .box {
        float: left;
        width: 50%;
        height: 100%;
      }
      .clearfix {
        height: 100%;
        text-align: left;
      }
      .img {
        max-width: 100%;
      }
      .file {
        float: left;
        margin: 12px;
        width: 100%;
      }
    </style>
    <script type=text/javascript>
      var data = []; // 图片转矩阵对象
      var width, height; // 实际像素宽高
      var canvas; // canvas
      var ctx; // canvas的2s上下文

      function start(el) {
        // 创建canvas
        // var canvas = document.createElement("canvas");
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");
        // 设定宽高一致
        width = el.naturalWidth;
        height = el.naturalHeight;
        canvas.width = width;
        canvas.height = height;
        // 填充图片
        ctx.drawImage(el, 0, 0, width, height);
        // 获取图片数据
        var f = 0, t = 0;
        var imageData = ctx.getImageData(0, 0, width, height);
        var length = imageData.data.length;
        for(var index = 0; index < length; index++) {
          if (index % 4 === 0) {
            var x = index / 4 % width, y = Math.floor(index / 4 / width);
            if(x === 0) data.push([]);
            // RGBA数据 转黑白（Boolean）数据
            data[y][x] = imageData.data[index] + imageData.data[index + 1] + imageData.data[index + 2] > 460;
            if(data[y][x]) t++;
            else f++;
          }
        };
        // 图像识别
        recog(50, 50, width, height);
      }
      function recog(x, y, w, h) {
        var i, j;
        for(j = 0; j < h; j++) {
          for(i = 0; i < w; i++) {
            if(data[y + j][x + i]) {
              var area = IdentArea(x + i, y + j);
              dealArea(x + i, y + j, area.w, area.h);
            }
          }
        }
      }
      function IdentArea(x, y) {
        if(width - x < 10 || height - y < 10) return {w: 1, h: 1};
        var w = 0, h = 0, t = 0;
        for(var xi = x; xi < width; xi++) {
          if(data[y][xi]) w++;
          else if(!data[y + 1][xi] && !data[y + 2][xi] && !data[y + 3][xi] && !data[y + 4][xi]) {
            break;
          }else w++;
        }
        for(var yi = y; yi < height; yi++) {
          if(data[yi][x]) h++;
          else if(!data[yi][x + 1] && !data[yi][x + 2] && !data[yi][x + 3] && !data[yi][x + 4]) {
            break;
          }else h++;
        }
        return {w: w, h: h};
      }
      function dealArea(x, y, w, h) {
        // 忽略太小的块
        if(w < 10 || h < 10) clearArea(x, y, w, h);
        else {
          var cn = countArea(x, y, w, h);
          // console.log('cn:' + cn);
          // 正方形小框判定
          if(Math.abs(w - h) < 2 && w < 25 && w > 12 && data[y - 3][x - 3] !== false && data[y + 5][x + w] === false && data[y + h + 1][x - 1] !== false) {
            // console.log('findrect');
            if(cn < 5) {
              ctx.fillStyle = "#ff69b480";
              ctx.strokeStyle = '#ff4500';
              ctx.lineWidth = 1;
              ctx.fillRect(x, y, w, h);
              ctx.strokeRect(x, y, w, h);
            }
            clearArea(x, y, w, h);
          }else if(cn < 5 && w > 50 && w * 1.5 > h) {
            ctx.fillStyle = "#87cefa80";
            ctx.strokeStyle = '#ff4500';
            ctx.lineWidth = 1;
            ctx.fillRect(x, y, w, h);
            ctx.strokeRect(x, y, w, h);
            clearArea(x, y, w, h);
            console.log(`${x} : ${y} : ${w} : ${h}`);
          }else {
            findLine(x, y, w, h);
            osmosis(x, y);
            recog(x, y, w, h);
          }
        }
      }
      // 清理块级区
      function clearArea(x, y, w, h) {
        var i, j;
        for(i = 0; i < w; i++) {
          for(j = 0; j < h; j++) {
            if(data[y + j][x + i]) data[y + j][x + i] = undefined;
          }
        }
      }
      // 统计区域内黑点数量
      function countArea(x, y, w, h) {
        var i, j, c = 0;
        for(i = 0; i < w; i++) {
          for(j = 0; j < h; j++) {
            if(!data[y + j][x + i]) c++;
          }
        }
        return c;
      }
      // 查找横线
      function findLine(x, y, w, h) {
        if(y < 30) return;
        var i, j, wi, s;
        for(j = 1; j < h; j++) {
          s = false;
          wi = 0;
          for(i = 1; i < w; i++) {
            if(s) {
              if(!data[y + j][x + i]) wi++;
              else {
                // console.log('l');
                if(wi > 50 && countArea(x + i - wi, y + j - 25, wi, 24) < 5) {
                  ctx.fillStyle = "#9400d380";
                  ctx.strokeStyle = '#ff4500';
                  ctx.lineWidth = 1;
                  ctx.fillRect(x + i - wi, y + j - 25, wi, 24);
                  ctx.strokeRect(x + i - wi, y + j - 25, wi, 24);
                  clearArea(x + i - wi, y + j - 25, wi, 26);
                }
                s = false;
                wi = 0;
              }
            }else if(!data[y + j][x + i] && data[y + j - 1][x + i] && data[y + j][x + i - 1] && countArea(x + i, y + j, 1, 5) < 4) {
              wi++;
              s = true;
            }
          }
        }
      }
      // 缩小查找范围
      function osmosis(x, y) {
        if(data[y][x]) {
          data[y][x] = undefined;
          if(x + 1 < width) osmosis(x + 1, y);
          if(y + 1 < height) osmosis(x, y + 1);
        }
      }

      function loadImg(el) {
        var file = el.files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById('img').setAttribute('src', e.target.result);
        };
        reader.readAsDataURL(file);
      }
    </script>
  </head>
  <body>
    <div class="clearfix">
      <input type="file" class="file" onchange="loadImg(this)">
      <div class="box"><img class="img" src="./test1.jpg" alt="" onload="start(this)" id="img"></div>
      <div class="box">
        <canvas id="canvas"></canvas>
      </div>
    </div>
  </body>
</html>























